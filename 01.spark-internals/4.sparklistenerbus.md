# 4.sparklistenerbus

在 `SparkContext` 初始化的时候会初始化 `LiveListenerBus` 如下代码。

```scala
// ${SPARK_HOME}/core/src/main/scala/org/apache/spark/SparkContext.scala

// SparkContext 在这里初始化的是 LiveListenerBus
private[spark] val listenerBus = new LiveListenerBus(this)    
```

进入 `LiveListenerBus` 类。

```scala
// ${SPARK_HOME}/core/src/main/scala/org/apache/spark/scheduler/LiveListenerBus.scala

/**
 * Asynchronously passes SparkListenerEvents to registered SparkListeners.
 *
 * Until `start()` is called, all posted events are only buffered. Only after this listener bus
 * has started will events be actually propagated to all attached listeners. This listener bus
 * is stopped when `stop()` is called, and it will drop further events after stopping.
 */
// SparkContext 唯一输入参数
// 继承关系 ListenerBus -> SparkListenerBus -> LiveListenerBus
private[spark] class LiveListenerBus(val sparkContext: SparkContext) extends SparkListenerBus {
	self =>
	
	// 导入 LiveListenerBus 伴生对象中声明的变量
	// - val name = "SparkListenerBus"
	// - val withinListenerThread: DynamicVariable[Boolean] = new DynamicVariable[Boolean](false)
	import LiveListenerBus._
	
	// 通过 spark.scheduler.listenerbus.eventqueue.size 配置设置队列最大长度
	// spark.scheduler.listenerbus.eventqueue.size 可以在 ${SPARK_HOME}/conf/spark-defaults.conf 中设置
	// 若没有设置，在 ${SPARK_HOME}/core/src/main/scala/org/apache/spark/internal/config/package.scala 中设置默认值为 10000
	private lazy val EVENT_QUEUE_CAPACITY = validateAndGetQueueSize()
	
	// 使用阻塞队列 LinkedBlockingQueue 初始化
	private lazy val eventQueue = new LinkedBlockingQueue[SparkListenerEvent](EVENT_QUEUE_CAPACITY)

	private def validateAndGetQueueSize(): Int = {
		// LISTENER_BUS_EVENT_QUEUE_SIZE 在 ${SPARK_HOME}/core/src/main/scala/org/apache/spark/internal/config/package.scala 中设置默认值为 10000
		val queueSize = sparkContext.conf.get(LISTENER_BUS_EVENT_QUEUE_SIZE)
		if (queueSize <= 0) {
			throw new SparkException("spark.scheduler.listenerbus.eventqueue.size must be > 0!")
		}
		queueSize
	}
}

```

